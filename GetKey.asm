	.z80
KBDPPA		EQU	0C100H;0C200H

PORT_A		EQU	KBDPPA
PORT_B		EQU	PORT_A+1
PORT_C		EQU	PORT_A+2
PORT_CTRL	EQU	PORT_A+3

Loop:	CALL	CONIN
	LD	C,A
	CALL	0F809h
	JP	Loop

CONIN:	;CALL	EMU_CLS
CONIN2:	CALL	KBD_STATUS
	OR	A
	JP	Z,CONIN2
	XOR	A
	LD	(KBDFLG),A
	LD	A,(LAST_K)
	RET

KBD_STATUS:
	LD	A,(PORT_C)		; 38 bytes
	RLA
	JP	NC,RlPressed	; если нажат RUS/LAT
	LD	A,(KBDFLG)
	OR	A
	RET	NZ		; если в SYMBUF уже есть символ
RlPressed:
	PUSH	HL
	LD	HL,(LAST_K)
	CALL	XF81B
	CP	L
	LD	L,A
	JP	Z,AFE2A
AFE1A:	LD	A,1
	LD	(APVFLG),A
	LD	H,0CH*2		; NB число опросов, чтобы зафиксировать код
AFE21:	XOR	A
AFE22:	LD	(LAST_K),HL
	POP	HL
	LD	(KBDFLG),A
	RET

; ??????????????????????????????????????????????

XF81B:	LD	A,(PORT_C)	; 30 bytes
	RLA
	LD	A,0FEH
	RET	NC		; RusLat нажата
AFE7D:
	XOR	A
	LD	(PORT_A),A
	LD	A,(RUSLAT)
	AND	00000001B
	OR	00000110B	; зажигаем/гасим светодиод
	LD	(PORT_CTRL),A
	LD	A,(PORT_B)
	INC	A
	JP	NZ,KbdScan
	DEC	A
	RET

; ??????????????????????????????????????????????

KbdScan:
	PUSH	HL			; 27 bytes
	LD	HL,7 shl 8 + 1
KbdS01:	LD	A,L
	RRCA
	LD	L,A
	CPL
	LD	(PORT_A),A
	LD	A,(PORT_B)
	CPL
	OR	A
	JP	NZ,KbdKeyPress
	DEC	H
	JP	P,KbdS01
KbdSNoKey:
	LD	A,0FFH
	POP	HL
	RET

; ??????????????????????????????????????????????

TABK1:	defb	0CH,1FH,1BH,0,1,2,3,4,5	  ; 9 bytes
TABK2:	defb	09,0AH,0DH,7FH,08H,19H,18H,1AH	; 8 bytes

; ??????????????????????????????????????????????

KbdKeyPress:
	LD	L,20H			; 47 bytes
PressLoop:
	LD	A,(PORT_B)
	CPL
	OR	A
	JP	Z,KbdSNoKey
	DEC	L
	JP	NZ,PressLoop
	LD	L,8
AFEC3:	DEC	L
	RLCA
	JP	NC,AFEC3
	LD	A,H
	LD	H,L
	LD	L,A
	CP	1
	JP	Z,AFEFA
	JP	C,AFEF3
	RLCA
	RLCA
	RLCA
	ADD	A,20H
	OR	H
	CP	5FH
	JP	NZ,AFF06
	LD	A,20H
	POP	HL
	RET

; ??????????????????????????????????????????????

AFEFA:	LD	A,H			; 32 bytes
	LD	HL,TABK2
AFEFE:	ADD	A,L
	LD	L,A
	LD	A,(HL)
	CP	40H
	POP	HL
AFF04:	RET	C
	PUSH	HL
AFF06:	LD	L,A
	LD	A,(PORT_C)
	LD	H,A
	AND	40H
	JP	NZ,AFF1A
	LD	A,L
	CP	40H
	JP	M,AFF3F
	AND	1FH
	POP	HL
	RET

; ??????????????????????????????????????????????

AFEF3:	LD	A,H			; 7 bytes
	LD	HL,TABK1
	JP	AFEFE

; ??????????????????????????????????????????????

AFE2A:	DEC	H			; в рег.A=код клав, в рег.H- COUNT
	JP	NZ,AFE21		; 39 bytes
	INC	A
	JP	Z,AFE22			; если код FF, то сброс флагов
	INC	A
	JP	Z,KEY_FE		; если код FE (RUSLAT)

	PUSH	BC			; КЛИК
	LD	BC,0205H		; B - длительность, C - высота
	;CALL	SND_BC
	POP	BC

	LD	A,(APVFLG)
	LD	H,0E0H
	DEC	A
	LD	(APVFLG),A
	JP	Z,AFE4C
	LD	H,18H			; скорость повтора
AFE4C:	LD	A,0FFH
	JP	AFE22

; ??????????????????????????????????????????????

AFF1A:	LD	A,(RUSLAT)		; 33 bytes
	OR	A
	JP	Z,AFF2A
	LD	A,L
	CP	40H
	JP	M,AFF2A
	OR	20H
	LD	L,A
AFF2A:	LD	A,H
	AND	20H
	JP	NZ,AFF3F
	LD	A,L
	CP	40H
	JP	M,AFF3B
	LD	A,L
	XOR	20H
	POP	HL
	RET

; ??????????????????????????????????????????????

AFF3B:	LD	A,L			; 23 bytes
	AND	2FH
	LD	L,A
AFF3F:	LD	A,L
	CP	40H
	POP	HL
	RET	P
	PUSH	HL
	LD	L,A
	AND	00FH
	CP	00CH
	LD	A,L
	JP	M,AFF50
	XOR	10H
AFF50:	POP	HL
	RET

; ??????????????????????????????????????????????

KEY_FE:	LD	A,(PORT_C)			; 17 bytes
	RLA
	JP	NC,KEY_FE		; ждём отпускания РУС/ЛАТ
	LD	A,(RUSLAT)
	CPL
	CALL	SET_RL
	JP	AFE1A

; ??????????????????????????????????????????????

SET_RL:	LD	(RUSLAT),A		; 6 bytes
	RET
;	JP	PUSK_VG



RUSLAT:	DS	1	; допустимо только 0 или FF
KBDFLG:	DS	1	; если =0, то есть символ в SYMBUF
LAST_K:	DS	2	; эти 2 байта должны следовать подряд
COUNT:	DS	1	; счётчик опросов (вначале 15)
APVFLG:	DS	1	; флаг автоповтора

	END
